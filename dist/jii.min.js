/*! Jii - v0.1.0 - 2012-10-29
* http://goliatone.github.com/jii/
* Copyright (c) 2012 goliatone; Licensed MIT, GPL */
var jii=function(){this.version="0.1.0"};(function(e,t,n){function i(e,t,n){var r,i,s;for(i=0,s=e.length;i<s;i++){r=e[i];if(!r)continue;n.event=r,n.target=r.target;if(!r.callback.apply(r.scope,t))break}}var r=e[n],s=[].slice,o={subscribe:function(e,t,n,r){var i=this._callbacks||(this._callbacks={}),s=i[e]||(i[e]=[]),o={};return o.topic=e,o.callback=t,o.scope=n||this,o.target=this,s.push(o),this},subscribers:function(e){return this._callbacks.hasOwnProperty(e)&&this._callbacks[e].length>0},publish:function(e,t){var n=s.call(arguments,1);t=t||{},n.push(t);var r,o,u;return(o=this._callbacks)?!(r=o[e])&&!o.all?this:((u=o.all)&&i.call(this,u,s.call(arguments,0),t),r&&i.call(this,r,n,t),this):this},unsubscribe:function(e,t){var n,r,i,s;if(!(r=this._callbacks))return this;if(!(n=r[e]))return this;for(i=0,s=n.length;i<s;i++)n[i].callback===t&&n.splice(i,1);return this}},u={mixins:{pubsub:o}},a=r(t).include(o).extend(u);e=e||this,t=t||"PubSub",e[t]=a})(jii,"PubSub","Module"),function(e,t,n){var r=function(e,n){n=n||r,typeof n=="string"&&(n=t[n]);var i=function(){"init"in this&&this.init.apply(this,arguments)};i.prototype.init=function(){};if(n){for(var s in n)n.hasOwnProperty(s)&&(i[s]=r.clone(n[s]));for(s in n.prototype)n.prototype.hasOwnProperty(s)&&(i.prototype[s]=r.clone(n.prototype[s]));var o=function(){this.ctor=this.constructor=i};o.prototype=n.prototype,i.prototype=new o,i.prototype._super=n.prototype}return i.extend=function(e,t){t=t||i;var n=e.extended;for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);return n&&n(t),t},i.include=function(e){var t=e.included;for(var n in e)e.hasOwnProperty(n)&&(i.fn[n]=e[n]);return t&&t(i),i},i.proxy=function(e){var t=this;return function(){return e.apply(t,arguments)}},i.fn=i.prototype,i.fn.parent=n,i.fn.proxy=i.proxy,i.prototype.__name__=i.__name__=e,i.prototype.__class__=i,t[e]=i,i};r.__name__="Module",r.__version__="0.0.1",r.decorator=function(e){var t=function(){};return t.prototype.decorate=function(){var t=0,n=arguments.length;for(;t<n;t++)e(arguments[t],this)},new t},r.override=function(e,t,n){e.parent=e.parent||{},e.parent[t]=e[t],e[t]=n},r.clone=function(t){return typeof t=="function"?t:typeof t!="object"?t:e.isArray(t)?e.extend([],t):e.extend({},t)},r.namespace=function(e){return t=e||t,t.hasOwnProperty(n)||(t[n]=r),t},t=t||this,n=n||"Module",t[n]=r}(jQuery,jii,"Module"),function(e,t,n){var r=e[n],i=Object.create||function(e){var t;return t=function(){},t.prototype=e,new t},s=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},o=function(e){if(!e)return!0;if(typeof e=="string")return e===""?!0:!1;if(e.hasOwnProperty("length")&&e.length===0)return!0;var t;for(t in e)if(e.hasOwnProperty(t))return!1;return!0},u=function(e){var t=Array.prototype.slice(arguments,1);for(var n in e)if(!s(e,n))return!1;return!0},a=function(e){return typeof e=="function"},f=function(e){return Object.prototype.toString.call(e)==="[object Array]"},l=function(e){if(typeof e!="object")return null;var t=[],n;for(n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t},c=function(e,t){if(e==null)return null;var n=e[t];return a(n)?n.call(e):n},h=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},p=function(e){var t=this.length;if(typeof e!="function")throw new TypeError;var n=new Array(t),r=arguments[1];for(var i=0;i<t;i++)i in this&&(n[i]=e.call(r,this[i],i,this));return n},d=function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);return e},v=function(e,t){e.filter(function(e){return t.indexOf(e)!==-1})},m=function(e){return e.charAt(0).toLowerCase()+e.slice(1)},g=r("Validator").extend({createValidator:function(e,t,n,r){var i=this.prototype.constructor;r=d(i.defaultOptions,r||{}),!n&&a(i[t])&&(n=i[t]),n&&!a(n)&&a(n[t])&&(n=n[t]);if(this.validators[t])return this.validators[t];var s=function(e){return typeof e=="string"&&(e=e.split(",").map(String.trim)),e};e=s(e);var o=function(){var i=this;i.name=t,i.attributes=e,i.message=r.message,i.skipOnError=r.skipOnError,i.validatesAttribute=function(e){return i.attributes.indexOf(e)!==-1},i.applyTo=function(e){return!0},i.validate=function(e){var t=Array.prototype.slice.call(arguments,1),r=n.apply(e,t);return console.log(this),r}};return this.validators[t]=new o,this.validators[t]},setMessage:function(e,t){var n=this.messages||(this.messages={});n[e]=t},getMessage:function(e){return this.messages[e]||this.defaultMessage}});g.defaultMessage="Error.",g.defaultOptions={message:g.defaultMessage,skipOnError:!1,on:[]},g.length=function(e,t){return this[e].length===t},g.range=function(e,t,n){},g.numerical=function(e){return!isNaN(this[e])},g.type=function(e,t){},g.required=function(e){return!o(this[e])},g.match=function(e,t){},g.email=function(e){},g.url=function(e){},g.compare=function(e,t){},g.$in=function(e,t){},g.$default=function(e,t){},g.exists=function(e){};var y=r(t).extend({records:{},grecords:{},attributes:[],extended:function(e){e.dispacher=new e,e.reset()},configure:function(e){this.attributes=e.attributes},clonesArray:function(e){var t,n=0,r=e.length,i=[];for(;n<r;n++)t=e[n],i.push(t.clone());return i},makeGid:function(){return"xxxxxxxx-xxxx-xxxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=Math.random()*16|0,n=e==="x"?t:t&3|8;return n.toString(16)}).toUpperCase()},isGid:function(e){return o(e)?!1:(console.log("isGid ",e),e=e.replace(/[A-Z\d]/g,function(){return 0}),e==="00000000-0000-0000-0000-000000000000")},reset:function(e){this.records={},this.grecords={},this.attributes=[]},add:function(e,t){t=t||{silent:!0};var n=f(e)?e.slice():[e],r=0,i=n.length,s;for(;r<i;r++)n[r]=this._prepareModel(n[r],t);r=0,i=n.length;for(;r<i;r++){e=n[r],s=this.has(e)&&this.get(e);if(s){t.merge&&s&&s.load(e),n.splice(r,1),--r,--i;continue}e.subscribe("all",this._handleModel,this,t),this.grecords[e.gid]=e,e.has("id")&&(this.records[e.id]=e)}return e},_prepareModel:function(e,t){if(e instanceof y)return e;t=t||{};var n=new this.prototype.__class__(e,t);return n},get:function(e){e=this.ensureId(e);if(!this.has(e))return null;var t;return(t=this.records[e])?t:this.grecords[e]},ensureId:function(e,t){if(typeof e=="object")if(s(e,"id"))e=e.id;else{if(!s(e,"gid")||!!t)return null;e=e.gid}return e},has:function(e){return e?(e=this.ensureId(e),s(this.records,e)||s(this.grecords,e)):!1},count:function(e){var t=0,n,r;r=e?this.grecords:this.records;for(n in r)r.hasOwnProperty(n)&&t++;return t},remove:function(e){if(!this.has(e))return null;var t=this.get(e);return t.unsubscribe("all",this.proxy(this._handleModel)),delete this.records[t.id],delete this.grecords[t.gid],t},_handleModel:function(e,t){switch(e){case"create":break;case"remove":break;case"destroy":this.remove(t.target.id)}},each:function(e){var t=this.records,n=[],r,i;for(r in t)t.hasOwnProperty(r)&&(i=t[r],n.push(e(i.clone())));return n},all:function(){return this.clonesArray(this.recordsValues())},first:function(){var e=this.recordsValues()[0];return e?e.clone():0},last:function(){var e=this.recordsValues(),t=e[e.length-1];return t?t.clone():void 0},toJSON:function(){return this.recordsValues()},fromJSON:function(e){if(!e)return;typeof e=="string"&&(e=JSON.parse(e));if(f(e)){var t=[],n=0,r=e.length,i;for(;n<r;n++)i=e[n],t.push(new this(i));return t}return new this(e)},fromForm:function(e){var t=new this;return t.fromForm(e)},recordsValues:function(){var e,t,n=[],r=this.records;for(e in r)r.hasOwnProperty(e)&&(t=r[e],n.push(t));return n}}).include({errors:{},validators:{},scenario:null,init:function(e,t){this.modelName=h(this.__name__),this.clearErrors(),e&&this.load(e,t),this.gid=this.ctor.makeGid(),this.ctor.add(this)},validate:function(e,t){t=t||{},t.clearErrors&&this.clearErrors();var n,r,i;n=this.getValidators();for(i in n)n.hasOwnProperty(i)&&(r=n[i],r.validate(this,e));return!this.hasErrors()},getValidators:function(e){this.getValidatorList();var t=[],n,r=this.getScenario();for(n in t)t.hasOwnProperty(n)&&(n=t[n],n.applyTo(r)&&(!e||n.validatesAttribute(e))&&t.push(n));return t},getValidatorList:function(){return this.validators||(this.validators=this.createValidators())},createValidators:function(){var e={};for(var t in this.rules)this.rules.hasOwnProperty(t)&&(t=this.rules[t],u(t,"name","attribute")&&(e[t.attribute]=t));return e},addError:function(e,t){var n=this.errors[e]||(this.errors[e]=[]);n.push(t)},addErrors:function(e){var t,n;for(n in e)e.hasOwnProperty(n)&&(t=e[n],f(t)?this.addErrors(t):this.addError(n,t))},clearErrors:function(e){e&&e in this.errors?delete this.errors[e]:this.errors={}},hasError:function(e){return this.errors.hasOwnProperty(e)},hasErrors:function(e){return e?this.hasError(e):o(this.errors)},getErrors:function(e){var t;return e?t=(this.errors[e]||[]).concat():t=d({},this.errors),t},getError:function(e){return this.hasError(e)?this.errors[e][0]:void 0},load:function(e){var t,n,r;for(t in e)e.hasOwnProperty(t)&&(n=e[t],a(this[t])?this[t](n):this[t]=n);return this},restore:function(){var e=this.constructor.findByGid(this.gid);return this.load(e.getAttributes()),e},get:function(e){return this[e]},set:function(e,t,n){var r=this[e];return this[e]=t,(!n||!n.silent)&&this.publish("update."+e,{old:r,value:t},n),this},has:function(e){return this.hasOwnProperty(e)},setScenario:function(e){if(!e||e===this.scenario)return;return this.scenario=e,this},getScenario:function(){return this.scenario},duplicate:function(e){var t=new this.constructor(this.getAttributes());return e===!1?t.gid=this.gid:delete t.id,t},clone:function(){return i(this)},hasAttribute:function(e){return this.getAttributeNames().indexOf(e)!==-1},getAttributeNames:function(){return this.constructor.attributes.concat()},getAttributes:function(e){var t,n=this.getAttributeNames();e&&f(e)&&(n=v(n,e));var r=0,i=n.length,s={};for(;r<i;r++)t=n[r],t in this&&(s[t]=c(this,t));return this.id&&(s.id=this.id),s},updateAttribute:function(e,t,n){var r=this[e];return this[e]=t,this.publish("update."+e,{old:r,value:t},n),this.save(n)},updateAttributes:function(e,t){var n=this.getAttributes();return this.load(e),this.publish("update.attributes",{old:n,values:e},t),this.save(t)},isNewRecord:function(){return!this.isRecord()},isEqual:function(e){return e?e.constructor!==this.constructor?!1:e.gid!==this.gid?!1:e.id!==this.id?!1:!0:!1},isValid:function(){return this.validate()},isInvalid:function(){return!this.validate()},isRecord:function(){return this.id&&this.id in this.constructor.records},toString:function(){return"["+this.__name__+" => "+" ]"},toJSON:function(){return this.getAttributes()},fromJSON:function(e){return this.load(e)}});y.prototype.metadata=function(e){},y.prototype.fromForm=function(e,t){var n=$(e).serializeArray(),r=0,i=n.length,s,o,u={};t=t||new RegExp("(^"+this.modelName+"\\[)(\\w+)(\\]$)");for(;r<i;r++)o=n[r],s=o.name.replace(t,"$2"),u[o.name]=o.value;return this.load(u),this};var b=r("ActiveRecord",y).extend({extended:function(){this.stores=[]},parseUrl:function(e,t){function n(){var e=arguments[1];return e in t?t[e]:""}return e.replace(/\{(\w+)\}/g,n)},getService:function(){return this._service},setService:function(e){var t=Array.prototype.slice.call(arguments,1);return t.unshift(this),this._service=e.apply(e,t),this},service:function(e,t,n){this._service.apply(this,arguments),n=n||{},console.log("SYNC: called with arguments: ",arguments,(new Date).valueOf());var r={};r.create={url:"/api/{model}/{action}",type:"POST"},r.read={url:"/api/{model}/",type:"GET"},r.update={url:"/api/{model}/{action}/{id}",type:"PUT"},r.destroy={url:"/api/{model}/delete/{id}",type:"POST"};var i={model:null,action:e,id:t.id};i.model=m(t.modelName);var s=this.parseUrl(r[e].url,i);switch(e){case"create":break;case"read":n.id&&(s+=n.id);break;case"update":break;case"delete":case"destroy":break;default:return}console.log("url: ",s),$.ajax({url:s,type:r[e].type,success:n.success,error:function(){console.log("error")}}),console.log("____________________________")},update:function(e,t,n){var r=this.find(e);return r?(r.updateAttributes(t,n),r):null},create:function(e,t){t=t||{};var n=new this(e);return t.skipSync=!0,n.save(t)},destroy:function(e,t){var n=this.find(e);return n&&n.destroy(t),n},change:function(e){a(e)},fetch:function(e,t,n){t=t||{},e&&(t.id=e);var r=this;t.success=function(e){console.log("on fetch success ",e),r.fromJSON(e)},this.service("read",new this,t)},find:function(e){var t=this.records[e];return!t&&this.isGid(e)?this.findByGid(e):t?t.clone():!1},findByPk:function(e){var t=this.records[e];return t?t.clone():!1},findByGid:function(e){var t=this.grecords[e];return t?t.clone():!1},exists:function(e){return this.findByPk(e)!==!1},reload:function(e,t){t=t||{},t.clear&&this.reset();var n=this.fromJSON(e);f(n)||(n=[n]);var r,i=0,s=n.length;for(;i<s;i++)r=n[i],r.id&&(this.records[r.id]=r),this.grecords[r.gid]=r;return this.publish("reload",this.clonesArray(n)),this},select:function(e){var t=function(){var t=this.records,n,r=[];for(var i in t)t.hasOwnProperty(i)&&(n=t[i],e(n)&&r.push(n));return r}.call(this);return this.clonesArray(t)},findByAttribute:function(e,t,n){var r=n?this.grecords:this.records,i,s,o;for(s in r)if(r.hasOwnProperty(s)){i=r[s],o=c(i,e);if(o===t)return i.clone()}return null},findAllByAttribute:function(e,t,n){return this.select(function(n){var r=c(n,e);return r===t})},deleteAll:function(){var e=this.records,t,n,r=[];for(t in e)e.hasOwnProperty(t)&&(n=e[t],r.push(delete this.records[t]));return r},destroyAll:function(){var e=this.records,t,n,r=[];for(t in e)e.hasOwnProperty(t)&&(n=e[t],r.push(this.records[t].destroy()));return r}}).include({service:function(){this.ctor.service.apply(this.ctor,arguments)},refresh:function(){},fetch:function(e){e=e||{};var t=this,n=e.success;return e.success=function(r,i,s){t.load(r),n&&n(t,r,e)},this.service("read",this,e),this},save:function(e){e=e||{},console.log("=============== SAVE"),e.validate!==!1&&this.isInvalid()&&this.publish("error",e),this.publish("beforeSave");var t=this.isNewRecord()?"create":"update",n=this[t](e);return this.publish("save",e),n},create:function(e){e=e||{},this.publish("beforeCreate",e);var t=this.duplicate(!1);this.has("id")&&(this.constructor.records[this.id]=t),this.constructor.grecords[this.gid]=t;var n=t.clone();return n.publish("create",e),console.log("::::::::::::::::::::::::::::::: ",arguments.callee.caller),e.skipSync&&this.service("create",this,e),this.setScenario("update"),n},update:function(e){if(this.isNewRecord()){console.log("JII","Cannot update record, is new.");return}e=e||{},this.publish("beforeUpdate",e);var t=this.constructor.records[this.id];t.load(this.getAttributes());var n=t.clone();return e.skipSync&&this.service("update",this,e),this.publish("update",e),n},destroy:function(e){e=e||{},this.publish("beforeDestroy",e);if(e.skipDestroy)return this;var t=this,n=e.success;return e.success=function(r){n&&n(t,r,e)},this.service("destroy",this,e),this.publish("destroy",e),this.destroyed=!0,this}}),w=r("LocalStore").include({id:"LocalStore",handleModels:function(e,t){console.log("*****************************************");switch(e){case"update":console.log("We have update: id ",t.target.id);break;case"create":console.log("We have create: gid ",t.target.gid);break;case"delete":console.log("We have delete: ",t.target.id);break;case"find":}console.log("*****************************************")}});e.LocalStore=w,e.Validator=g,e[t]=y}(jii,"Model","Module");